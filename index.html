<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>B√© Vui H·ªçc To√°n - Fix ReferenceError</title>
    
    <!-- Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #F0F4F8;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Hi·ªáu ·ª©ng m∆∞·ª£t m√† khi co gi√£n */
        .sync-scale {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* T√πy ch·ªânh thanh k√©o tr∆∞·ª£t */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #E2E8F0;
            border-radius: 4px;
        }
        input[type=range]::-webkit-slider-thumb {
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #3B82F6;
            cursor: pointer;
            -webkit-appearance: none;
            margin-top: -8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        /* Loading Spinner Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3b82f6;
            width: 40px;
            height: 40px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Th√™m tr·∫°ng th√°i Loading m·∫∑c ƒë·ªãnh -->
    <div id="root" class="h-screen w-full flex flex-col items-center justify-center gap-4 text-gray-400">
        <div class="loader"></div>
        <p class="font-bold text-sm animate-pulse">ƒêang t·∫£i B√© Vui H·ªçc To√°n...</p>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // ==========================================
        // 1. ICONS BLOCK
        // ==========================================
        function Icon({ path, size = 24, className = "", fill = "none" }) {
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
            );
        }

        const Icons = {
            Star: (p) => <Icon {...p} path={<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />} />,
            BookOpen: (p) => <Icon {...p} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            Brain: (p) => <Icon {...p} path={<><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>} />,
            Refresh: (p) => <Icon {...p} path={<><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></>} />,
            Check: (p) => <Icon {...p} path={<polyline points="20 6 9 17 4 12"/>} />,
            X: (p) => <Icon {...p} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
            Play: (p) => <Icon {...p} path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
            Stop: (p) => <Icon {...p} path={<rect width="18" height="18" x="3" y="3" rx="2" />} />,
            Delete: (p) => <Icon {...p} path={<path d="M20 5H9l-7 7 7 7h11a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Z"/>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Clock: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />,
            Sigma: (p) => <Icon {...p} path={<path d="M18 6H5a2 2 0 0 0 0 4h8v4H5a2 2 0 0 0 0 4h13" />} />,
            Trophy: (p) => <Icon {...p} path={<path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6m12 5h1.5a2.5 2.5 0 0 0 0-5H18m-8 10v2c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22h10c0-1.76-.85-3.25-2.03-3.79-.5-.23-.97-.66-.97-1.21v-2m4-12H6v7a6 6 0 0 0 12 0V2Z" />} />,
            ThumbsUp: (p) => <Icon {...p} path={<><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2h0a3.13 3.13 0 0 1 3 3.88Z"/></>} />,
            ThumbsDown: (p) => <Icon {...p} path={<><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22h0a3.13 3.13 0 0 1-3-3.88Z"/></>} />,
            XCircle: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />,
            Monitor: (p) => <Icon {...p} path={<><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></>} />,
            Layers: (p) => <Icon {...p} path={<><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></>} />,
            Crop: (p) => <Icon {...p} path={<><path d="M6 2v14a2 2 0 0 0 2 2h14"/><path d="M18 22V8a2 2 0 0 0-2-2H2"/></>} />,
            Shuffle: (p) => <Icon {...p} path={<><polyline points="16 3 21 3 21 8"/><line x1="4" x2="21" y1="20" y2="3"/><polyline points="21 16 21 21 16 21"/><line x1="15" x2="21" y1="15" y2="21"/><line x1="4" x2="9" y1="4" y2="9"/></>} />,
            SortNumeric: (p) => <Icon {...p} path={<><path d="M4 6h9"/><path d="M4 12h9"/><path d="M4 18h9"/><path d="M19 5a2.5 2.5 0 0 1 0 5H17"/><path d="M17 14h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2v-6"/></>} />,
        };

        // ==========================================
        // 2. ATOMS & SMALL BLOCKS
        // ==========================================
        const Badge = ({ children, color = "blue" }) => (
            <div className={`px-2 py-0.5 rounded-full border border-${color}-100 bg-${color}-50 text-${color}-600 text-[10px] md:text-xs font-bold shadow-sm inline-block`}>
                {children}
            </div>
        );

        const CircleButton = ({ icon, onClick, active, color = "blue", disabled, label }) => (
            <div className="flex flex-col items-center gap-1">
                <button 
                    onClick={onClick} disabled={disabled}
                    className={`p-2.5 md:p-3.5 rounded-full transition-all active:scale-90 shadow-sm
                    ${disabled ? 'bg-gray-50 text-gray-200' : 
                      active ? `bg-${color}-100 text-${color}-600 shadow-inner ring-2 ring-${color}-200` : `bg-${color}-500 text-white hover:bg-${color}-600 shadow-${color}-200`}
                    `}
                >
                    {icon}
                </button>
                {label && <span className="text-[8px] md:text-[10px] font-bold text-gray-400 uppercase tracking-wide">{label}</span>}
            </div>
        );

        const TableSelector = ({ current, onSelect }) => (
            <div className="flex justify-center items-center gap-1.5 overflow-x-auto no-scrollbar py-2 px-4 bg-white/50 border-b border-gray-100">
                {[2, 3, 4, 5, 6, 7, 8, 9].map((num) => (
                    <button
                        key={num} onClick={() => onSelect(num)}
                        className={`flex-shrink-0 w-8 h-8 md:w-9 md:h-9 rounded-lg font-black text-xs transition-all border
                        ${current === num ? 'bg-blue-600 text-white border-blue-600 scale-105 shadow-md' : 'bg-white text-gray-400 border-gray-100 hover:bg-gray-50'}`}
                    >
                        {num}
                    </button>
                ))}
                <button
                    onClick={() => onSelect('all')}
                    className={`flex-shrink-0 w-8 h-8 md:w-9 md:h-9 rounded-lg font-black text-xs transition-all border flex items-center justify-center
                    ${current === 'all' ? 'bg-purple-600 text-white border-purple-600 scale-105 shadow-md' : 'bg-white text-purple-400 border-purple-100 hover:bg-purple-50'}`}
                >
                    <Icons.Sigma size={16} />
                </button>
            </div>
        );

        // ==========================================
        // 3. SETTINGS PANEL (Th√™m ch·ªçn t·ªâ l·ªá 3:4, 1:1, etc)
        // ==========================================
        const SettingsPanel = ({ isOpen, onClose, scale, setScale, currentAppSizeId, setAppSizeId, ratioMode, setRatioMode }) => {
            if (!isOpen) return null;
            const appSizes = [
                { id: 'xs', label: 'X' }, { id: 'sm', label: 'S' }, { id: 'md', label: 'M' }, { id: 'full', label: 'Full' },
            ];
            const ratioOptions = [
                { id: '3:4', label: '3:4', desc: 'D·ªçc' },
                { id: '1:1', label: '1:1', desc: 'Vu√¥ng' },
                { id: '4:3', label: '4:3', desc: 'Ngang' },
                { id: '16:9', label: '16:9', desc: 'R·ªông' },
            ];

            return (
                <div className="absolute top-16 right-4 z-[200] w-72 md:w-80 bg-white/95 backdrop-blur-md rounded-3xl shadow-2xl border-2 border-blue-50 animate-in slide-in-from-top-4 fade-in duration-300 overflow-hidden">
                    <div className="p-4 border-b border-gray-100 flex items-center justify-between bg-blue-50/20">
                        <div className="flex items-center gap-2 font-black text-blue-600 text-sm uppercase tracking-tighter">
                            <Icons.Settings size={18} /> C√†i ƒë·∫∑t hi·ªÉn th·ªã
                        </div>
                        <button onClick={onClose} className="text-gray-400 hover:text-red-500 transition-colors">
                            <Icons.XCircle size={24} />
                        </button>
                    </div>
                    
                    <div className="p-5 space-y-6">
                        {/* Scale Slider */}
                        <div>
                            <div className="flex items-center justify-between mb-3">
                                <h3 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2"><Icons.Layers size={14}/> Zoom th·∫ª:</h3>
                                <span className="text-sm font-black text-blue-600">{scale}%</span>
                            </div>
                            <input 
                                type="range" min="50" max="150" step="5" value={scale} 
                                onChange={(e) => setScale(parseInt(e.target.value))}
                                className="w-full"
                            />
                            <div className="flex justify-between mt-1 text-[10px] text-gray-300 font-bold">
                                <span>NH·ªé</span><span>CHU·∫®N</span><span>L·ªöN</span>
                            </div>
                        </div>

                        {/* Aspect Ratio Selector */}
                        <div>
                            <h3 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2 mb-3"><Icons.Crop size={14}/> T·ªâ l·ªá khung h√¨nh:</h3>
                            <div className="grid grid-cols-4 gap-1.5">
                                {ratioOptions.map((opt) => (
                                    <button 
                                        key={opt.id} onClick={() => setRatioMode(opt.id)} 
                                        className={`p-2 rounded-xl border-2 transition-all flex flex-col items-center justify-center gap-0.5
                                        ${ratioMode === opt.id ? 'border-blue-500 bg-blue-50 text-blue-800 shadow-sm' : 'border-gray-100 bg-white text-gray-400 hover:bg-gray-50'}`}
                                    >
                                        <span className="text-[10px] font-black">{opt.label}</span>
                                        <span className="text-[8px] font-medium opacity-70">{opt.desc}</span>
                                    </button>
                                ))}
                            </div>
                        </div>

                        {/* App Frame Size */}
                        <div>
                            <h3 className="text-xs font-bold text-gray-500 uppercase flex items-center gap-2 mb-3"><Icons.Monitor size={14}/> Khung ·ª©ng d·ª•ng:</h3>
                            <div className="grid grid-cols-4 gap-1.5">
                                {appSizes.map((opt) => (
                                    <button 
                                        key={opt.id} onClick={() => setAppSizeId(opt.id)} 
                                        className={`p-2 rounded-xl border-2 transition-all text-[10px] font-black ${currentAppSizeId === opt.id ? 'border-blue-500 bg-blue-50 text-blue-800 shadow-sm' : 'border-gray-100 bg-white text-gray-400'}`}
                                    >
                                        {opt.label}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 4. ORGANISMS & SCREENS
        // ==========================================
        const FlashCard = ({ table, factor, isInputMode, userAnswer, checkStatus, isPlaying, sizeStyle }) => (
            <div 
                style={sizeStyle.card}
                className={`bg-white rounded-[2rem] shadow-lg border border-gray-100 flex flex-col items-center justify-center sync-scale relative overflow-hidden ${isPlaying ? 'ring-4 ring-green-50 scale-[1.02]' : ''}`}
            >
                <div className="flex items-center justify-center flex-1 w-full">
                    <span style={sizeStyle.number} className="font-black text-gray-800 leading-none transition-all">{table}</span>
                    <span style={sizeStyle.operator} className="text-gray-200 font-light mx-2 md:mx-4 transition-all">√ó</span>
                    <span style={sizeStyle.number} className="font-black text-blue-600 leading-none transition-all">{factor}</span>
                </div>
                
                {/* Decor divider */}
                <div className="w-full px-8 opacity-50"><div className="w-full h-0.5 bg-gray-50"></div></div>

                <div className="flex items-center justify-center flex-1 w-full relative">
                    <span style={sizeStyle.operator} className="text-gray-200 font-light transition-all absolute left-6 md:left-8">=</span>
                    {isInputMode ? (
                        <div style={{...sizeStyle.number, ...sizeStyle.inputWidth}} className={`font-black text-center border-b-2 md:border-b-4 border-dashed leading-none mx-2 md:mx-4 transition-all ${checkStatus === 'correct' ? 'text-green-500 border-green-500' : checkStatus === 'incorrect' ? 'text-red-500 border-red-500' : 'text-blue-600 border-blue-100'}`}>
                            {userAnswer || '?'}
                        </div>
                    ) : (
                        <span style={sizeStyle.number} className="font-black text-green-500 leading-none transition-all">{table * factor}</span>
                    )}
                </div>
                {checkStatus && (
                    <div style={sizeStyle.feedbackText} className="absolute bottom-4 font-black animate-in fade-in slide-in-from-bottom-2 transition-all w-full text-center">
                        <span className={`px-4 py-1 rounded-full ${checkStatus === 'correct' ? 'bg-green-100 text-green-600' : 'bg-red-50 text-red-500'}`}>
                            {checkStatus === 'correct' ? 'CH√çNH X√ÅC!' : `ƒê√ÅP √ÅN L√Ä ${table * factor}`}
                        </span>
                    </div>
                )}
            </div>
        );

        const MenuScreen = ({ startStudy, startQuiz, openSettings }) => (
            <div className="flex flex-col items-center justify-center min-h-full space-y-8 md:space-y-12 animate-in fade-in zoom-in duration-500 p-6 relative overflow-y-auto">
                <button onClick={openSettings} className="absolute top-4 right-4 p-2.5 bg-white shadow-sm hover:shadow-md rounded-full text-gray-400 hover:text-blue-600 transition-all border border-gray-100 z-20">
                    <Icons.Settings size={22} />
                </button>
                <div className="text-center px-4">
                    <h1 className="text-4xl md:text-7xl font-black text-blue-600 drop-shadow-sm mb-2 leading-tight tracking-tight">B√© Vui H·ªçc To√°n</h1>
                    <p className="text-sm md:text-xl text-gray-400 font-medium uppercase tracking-widest">C√πng b√© gi·ªèi to√°n m·ªói ng√†y üöÄ</p>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 md:gap-8 w-full max-w-3xl px-4">
                    <button onClick={startStudy} className="group flex flex-col items-center justify-center p-6 md:p-10 bg-white rounded-[2.5rem] shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all border border-gray-100 hover:border-green-100">
                        <div className="bg-green-50 p-4 md:p-6 rounded-full mb-4 group-hover:bg-green-100 transition-colors">
                            <Icons.BookOpen size={36} className="text-green-600 md:w-12 md:h-12" />
                        </div>
                        <span className="text-xl md:text-3xl font-black text-gray-800">H·ªçc B√†i</span>
                        <span className="text-xs md:text-base text-gray-400 mt-1">Xem & T·ª± gi·∫£i</span>
                    </button>
                    <button onClick={startQuiz} className="group flex flex-col items-center justify-center p-6 md:p-10 bg-white rounded-[2.5rem] shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all border border-gray-100 hover:border-orange-100">
                        <div className="bg-orange-50 p-4 md:p-6 rounded-full mb-4 group-hover:bg-orange-100 transition-colors">
                            <Icons.Brain size={36} className="text-orange-600 md:w-12 md:h-12" />
                        </div>
                        <span className="text-xl md:text-3xl font-black text-gray-800">Luy·ªán T·∫≠p</span>
                        <span className="text-xs md:text-base text-gray-400 mt-1">Tr·∫Øc nghi·ªám nhanh</span>
                    </button>
                </div>
            </div>
        );

        const QuizScreen = ({ goHome, score, questionCount, TOTAL_QUESTIONS, currentQuestion, feedback, handleAnswer, openSettings, isSettingsOpen, dynStyle }) => {
            if (!currentQuestion) return null;
            return (
                <div className="flex flex-col h-full overflow-hidden">
                    <div className="pt-3 pb-2 px-4 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-100 flex items-center justify-between shadow-sm">
                        <button onClick={goHome} className="p-1.5 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all"><Icons.ArrowLeft size={20} className="text-gray-600" /></button>
                        <h2 className="text-xs md:text-base font-black text-gray-500 uppercase tracking-widest">C√ÇU {questionCount + 1}/{TOTAL_QUESTIONS}</h2>
                        <div className="flex items-center gap-2">
                            <div className="flex items-center gap-2 mr-2"><Icons.ThumbsUp size={16} className="text-green-500"/><span className="font-black text-green-600 text-sm">{score}</span></div>
                            <button onClick={openSettings} className={`p-1.5 shadow-sm border rounded-lg transition-all active:scale-90 ${isSettingsOpen ? 'bg-blue-600 text-white' : 'bg-white text-blue-500 border-gray-100'}`}><Icons.Settings size={20} /></button>
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar bg-[#F8FAFC] flex flex-col items-center justify-center">
                        <div className="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] shadow-lg w-full max-w-[240px] md:max-w-md text-center relative overflow-hidden border border-gray-100">
                            {feedback === 'correct' && <div className="absolute inset-0 bg-green-500/90 flex items-center justify-center animate-in fade-in"><Icons.Check size={80} className="text-white animate-bounce" /></div>}
                            {feedback === 'incorrect' && <div className="absolute inset-0 bg-red-500/90 flex flex-col items-center justify-center animate-in fade-in p-4"><Icons.X size={80} className="text-white animate-pulse" /><p className="text-white font-black mt-2 text-xl">ƒê√ÅP √ÅN: {currentQuestion.correctAnswer}</p></div>}
                            <span className="text-[10px] md:text-sm text-gray-300 font-black mb-2 block uppercase tracking-widest italic">T√≠nh nhanh n√†o ‚ö°</span>
                            {/* D√πng dynStyle cho c·ª° ch·ªØ c√¢u h·ªèi */}
                            <div style={{ fontSize: `calc(${dynStyle.number.fontSize} * 1.5)` }} className="font-black text-gray-800 leading-none transition-all">{currentQuestion.num1} <span className="text-orange-500 italic px-2">√ó</span> {currentQuestion.num2}</div>
                        </div>
                        <div className="grid grid-cols-2 gap-2 md:gap-4 w-full max-w-[280px] md:max-w-xl mt-4 md:mt-6">
                            {currentQuestion.answers.map((ans, idx) => (
                                <button key={idx} onClick={() => handleAnswer(ans)} disabled={feedback !== null}
                                    style={{ fontSize: `calc(${dynStyle.number.fontSize} * 0.5)` }}
                                    className={`py-3 md:py-6 rounded-xl md:rounded-[2rem] font-black transition-all shadow-md border-b-4 ${feedback ? 'bg-gray-50 text-gray-200 border-gray-100' : 'bg-white text-blue-600 hover:bg-blue-600 hover:text-white border-blue-50 active:translate-y-1 active:border-b-0'}`}
                                >{ans}</button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 4. MAIN APPLICATION
        // ==========================================
        const App = () => {
            const [screen, setScreen] = useState('menu'); 
            const [selectedTable, setSelectedTable] = useState(2);
            const [studyFactor, setStudyFactor] = useState(1);
            const [score, setScore] = useState(0);
            const [questionCount, setQuestionCount] = useState(0);
            const [currentQuestion, setCurrentQuestion] = useState(null);
            const [feedback, setFeedback] = useState(null);
            const [isRandomMode, setIsRandomMode] = useState(false); // Default to Random mode
            
            // Layout & Scaling States
            const [appSizeId, setAppSizeId] = useState('md');
            const [scale, setScale] = useState(100); 
            const [ratioMode, setRatioMode] = useState('3:4'); // '3:4', '1:1', '4:3', '16:9'

            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isTimeLimitEnabled, setIsTimeLimitEnabled] = useState(true);
            const [timeLimitValue, setTimeLimitValue] = useState(7);
            const [currentDisplayTable, setCurrentDisplayTable] = useState(2);
            const [isInputMode, setIsInputMode] = useState(false);
            const [userAnswer, setUserAnswer] = useState('');
            const [checkStatus, setCheckStatus] = useState(null);
            const [stats, setStats] = useState({ correct: 0, incorrect: 0 });
            const [isPlaying, setIsPlaying] = useState(false);
            const shuffledQueueRef = useRef([]);

            // Mapper cho Khung ngo√†i (App Container)
            const getAppFrameClasses = () => {
                switch(appSizeId) {
                    case 'xs': return 'max-w-xl h-[100dvh] md:h-[65vh] md:max-h-[600px] md:my-4';
                    case 'sm': return 'max-w-2xl h-[100dvh] md:h-[75vh] md:max-h-[700px] md:my-4';
                    case 'full': return 'max-w-full h-[100dvh] m-0 rounded-none border-none';
                    default: return 'max-w-4xl h-[100dvh] md:h-[90vh] md:max-h-[850px] md:my-4';
                }
            };

            // H√†m t√≠nh to√°n Size Styles - Logic m·ªõi h·ªó tr·ª£ T·ªâ l·ªá khung h√¨nh
            const getDynamicSizeStyles = () => {
                const s = scale / 100;
                let baseW = 320; // Default width basis
                let baseH = 430; // Default height basis

                // T√≠nh to√°n Base dimensions d·ª±a tr√™n Ratio Mode
                switch (ratioMode) {
                    case '1:1': baseW = 380; baseH = 380; break;
                    case '4:3': baseW = 420; baseH = 315; break;
                    case '16:9': baseW = 480; baseH = 270; break;
                    case '3:4': 
                    default: baseW = 320; baseH = 426; break;
                }

                // Apply Scale Factor
                const finalW = baseW * s;
                const finalH = baseH * s;

                // Adjust font size based on the smaller dimension to prevent overflow
                const minDim = Math.min(finalW, finalH);
                
                return {
                    card: {
                        width: `${finalW}px`,
                        height: `${finalH}px`,
                        // Lo·∫°i b·ªè maxWidth/minHeight c≈© ƒë·ªÉ force theo t·ªâ l·ªá
                    },
                    number: { fontSize: `${Math.min(80, minDim * 0.25)}px` }, // Auto scale font
                    operator: { fontSize: `${Math.min(40, minDim * 0.15)}px` },
                    inputWidth: { minWidth: `${finalW * 0.4}px` },
                    feedbackText: { fontSize: `${Math.max(10, minDim * 0.04)}px` },
                    keypadText: { fontSize: `${30 * s}px` },
                    keypadBtnPadding: { padding: `${12 * s}px 0` },
                    containerGap: `${24 * s}px`
                };
            };
            
            // Fix ReferenceError
            const appFrameClass = getAppFrameClasses();
            const dynStyle = getDynamicSizeStyles();

            const nextStudyCalculation = useCallback(() => {
                if (selectedTable === 'all') setCurrentDisplayTable(Math.floor(Math.random() * 8) + 2);
                else setCurrentDisplayTable(selectedTable);

                setStudyFactor((prev) => {
                    if (isRandomMode) {
                        // Logic t·∫°o s·ªë ng·∫´u nhi√™n theo v√≤ng l·∫∑p (kh√¥ng tr√πng l·∫∑p cho ƒë·∫øn khi h·∫øt v√≤ng)
                        if (shuffledQueueRef.current.length === 0) {
                            // T·∫°o m·∫£ng m·ªõi [1..10]
                            const newQueue = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
                            // Fisher-Yates Shuffle
                            for (let i = newQueue.length - 1; i > 0; i--) {
                                const j = Math.floor(Math.random() * (i + 1));
                                [newQueue[i], newQueue[j]] = [newQueue[j], newQueue[i]];
                            }
                            
                            // Tr√°nh tr∆∞·ªùng h·ª£p s·ªë v·ª´a h·ªçc (prev) tr√πng v·ªõi s·ªë ti·∫øp theo (cu·ªëi m·∫£ng v√¨ d√πng pop)
                            // N·∫øu tr√πng th√¨ ƒë·ªïi ch·ªó v·ªõi ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n
                            if (newQueue[newQueue.length - 1] === prev) {
                                [newQueue[0], newQueue[newQueue.length - 1]] = [newQueue[newQueue.length - 1], newQueue[0]];
                            }
                            
                            shuffledQueueRef.current = newQueue;
                        }
                        return shuffledQueueRef.current.pop();
                    } else {
                        // Logic tu·∫ßn t·ª± c≈©
                        return prev >= 10 ? 1 : prev + 1;
                    }
                });
                setUserAnswer(''); setCheckStatus(null);
            }, [selectedTable, isRandomMode]);

            const generateQuestionData = () => {
                const n1 = Math.floor(Math.random() * 8) + 2;
                const n2 = Math.floor(Math.random() * 10) + 1;
                const correct = n1 * n2;
                let ans = [correct];
                while(ans.length < 4) {
                    let w = Math.random() > 0.5 ? correct + Math.floor(Math.random()*5)+1 : Math.max(1, correct - Math.floor(Math.random()*5)-1);
                    if(!ans.includes(w)) ans.push(w);
                }
                return { num1: n1, num2: n2, correctAnswer: correct, answers: ans.sort(() => Math.random() - 0.5) };
            };

            const handleAnswer = (val) => {
                if(feedback) return;
                const isCorrect = val === currentQuestion.correctAnswer;
                if(isCorrect) { setScore(score + 1); setFeedback('correct'); } else setFeedback('incorrect');
                setTimeout(() => {
                    if(questionCount + 1 >= 10) setScreen('result');
                    else { setQuestionCount(questionCount + 1); setFeedback(null); setCurrentQuestion(generateQuestionData()); }
                }, 1500);
            };

            const handleSubmitStudy = () => {
                if (!userAnswer || checkStatus) return;
                if (parseInt(userAnswer) === currentDisplayTable * studyFactor) {
                    setCheckStatus('correct'); setStats(p => ({...p, correct: p.correct + 1}));
                } else {
                    setCheckStatus('incorrect'); setStats(p => ({...p, incorrect: p.incorrect + 1}));
                }
                setTimeout(nextStudyCalculation, 1200);
            };

            useEffect(() => {
                let interval;
                if (isPlaying) {
                    interval = setInterval(nextStudyCalculation, 3000);
                } else if (isInputMode && isTimeLimitEnabled && !userAnswer && !checkStatus) {
                    interval = setInterval(() => {
                        // Logic m·ªõi: H·∫øt gi·ªù -> T√≠nh Sai -> Hi·ªán ƒë√°p √°n -> Chuy·ªÉn c√¢u
                        setStats(prev => ({...prev, incorrect: prev.incorrect + 1}));
                        setCheckStatus('incorrect');
                        setTimeout(() => {
                            nextStudyCalculation();
                        }, 1500); 
                    }, timeLimitValue * 1000);
                }
                return () => clearInterval(interval);
            }, [isPlaying, isInputMode, isTimeLimitEnabled, timeLimitValue, userAnswer, checkStatus, nextStudyCalculation]);

            return (
                <div className="min-h-[100dvh] bg-[#F0F4F8] flex items-center justify-center p-0 md:p-4 overflow-hidden">
                    <div className={`w-full ${appFrameClass} bg-white md:rounded-[3rem] shadow-2xl relative overflow-hidden border-2 md:border-[12px] border-white app-container-sync flex flex-col`}>
                        <div className="absolute inset-0 opacity-[0.015] pointer-events-none">
                            <div className="absolute top-10 left-10 rotate-12"><Icons.Star size={150} /></div>
                            <div className="absolute bottom-40 right-10 -rotate-12"><Icons.Brain size={250} /></div>
                        </div>

                        <div className="relative z-10 flex-1 overflow-hidden flex flex-col">
                            {screen === 'menu' && (
                                <MenuScreen 
                                    startStudy={() => {setStudyFactor(1); setIsInputMode(false); setScreen('study'); nextStudyCalculation();}} 
                                    startQuiz={() => {setScore(0); setQuestionCount(0); setFeedback(null); setCurrentQuestion(generateQuestionData()); setScreen('quiz');}} 
                                    openSettings={() => setIsSettingsOpen(true)} 
                                />
                            )}
                            
                            {screen === 'study' && (
                                <div className="flex flex-col h-full overflow-hidden animate-in fade-in duration-500">
                                    <div className="pt-3 pb-2 px-4 bg-white/80 backdrop-blur-sm z-10 border-b border-gray-100 flex items-center justify-between shadow-sm">
                                        <button onClick={() => setScreen('menu')} className="p-1.5 bg-gray-50 hover:bg-gray-100 rounded-lg transition-all"><Icons.ArrowLeft size={20} className="text-gray-600" /></button>
                                        <h2 className="text-[10px] md:text-sm font-black text-gray-500 uppercase tracking-widest">{selectedTable === 'all' ? "T·ªîNG H·ª¢P" : `B·∫¢NG NH√ÇN ${selectedTable}`}</h2>
                                        <button onClick={() => setIsSettingsOpen(!isSettingsOpen)} className={`p-1.5 shadow-sm border rounded-lg transition-all active:scale-90 ${isSettingsOpen ? 'bg-blue-600 text-white' : 'bg-white text-blue-500 border-gray-100'}`}><Icons.Settings size={20} /></button>
                                    </div>
                                    <TableSelector current={selectedTable} onSelect={(t) => { setSelectedTable(t); nextStudyCalculation(); }} />
                                    
                                    <div className="flex-1 overflow-y-auto p-4 md:p-6 no-scrollbar bg-[#F8FAFC] flex flex-col items-center justify-center relative">
                                        <div 
                                            style={{ gap: dynStyle.containerGap }}
                                            className={`flex flex-col md:flex-row items-center md:items-stretch justify-center w-full transition-all duration-500`}
                                        >
                                            <FlashCard 
                                                table={currentDisplayTable} factor={studyFactor} 
                                                isInputMode={isInputMode} userAnswer={userAnswer} 
                                                checkStatus={checkStatus} isPlaying={isPlaying}
                                                sizeStyle={dynStyle}
                                            />
                                            <div style={dynStyle.card} className="flex flex-col transition-all duration-500">
                                                {isInputMode ? (
                                                    <div className="bg-white p-5 md:p-6 rounded-[2rem] shadow-lg border border-gray-100 flex flex-col gap-3 h-full justify-center w-full animate-in slide-in-from-right-8 fade-in">
                                                        <div className="flex justify-between items-center bg-gray-50 px-4 py-1.5 rounded-2xl border border-gray-100">
                                                            <div className="flex items-center gap-2"><Icons.ThumbsUp size={18} className="text-green-500" /><span className="text-sm md:text-lg font-black text-green-600">{stats.correct}</span></div>
                                                            <Badge color="orange">{timeLimitValue}s</Badge>
                                                            <div className="flex items-center gap-2"><Icons.ThumbsDown size={18} className="text-red-400" /><span className="text-sm md:text-lg font-black text-red-400">{stats.incorrect}</span></div>
                                                        </div>
                                                        <div className="grid grid-cols-3 gap-2 flex-1 items-center">
                                                            {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => (
                                                                <button key={n} onClick={() => setUserAnswer(p => p.length < 3 ? p + n : p)} style={{...dynStyle.keypadText, ...dynStyle.keypadBtnPadding}} className={`bg-white hover:bg-blue-50 text-blue-600 font-black rounded-xl border-b-4 border-gray-100 active:border-b-0 h-full transition-all`}>{n}</button>
                                                            ))}
                                                            <button onClick={() => setUserAnswer(p => p.slice(0, -1))} className="bg-red-50 text-red-400 rounded-xl border-b-4 border-red-100 flex items-center justify-center h-full active:border-b-0"><Icons.Delete size={24} /></button>
                                                            <button onClick={() => setUserAnswer(p => p.length < 3 ? p + '0' : p)} style={dynStyle.keypadText} className={`bg-white text-blue-600 font-black rounded-xl border-b-4 border-gray-100 h-full active:border-b-0`}>0</button>
                                                            <button onClick={handleSubmitStudy} className="bg-blue-600 text-white rounded-xl border-b-4 border-blue-800 flex items-center justify-center shadow-lg h-full active:border-b-0 hover:bg-blue-700"><Icons.Check size={28} /></button>
                                                        </div>
                                                        <button onClick={() => { setIsInputMode(false); setStats({correct:0, incorrect:0}); }} className="text-gray-300 font-bold py-1 text-[8px] md:text-[10px] uppercase text-center hover:text-red-500">Quay l·∫°i xem</button>
                                                    </div>
                                                ) : (
                                                    <div className="flex flex-col justify-center h-full w-full gap-3 md:gap-6 animate-in fade-in">
                                                        {/* Time limit block */}
                                                        <div className="flex items-center justify-between bg-white px-4 py-3 md:py-4 rounded-3xl border border-gray-100 shadow-sm w-full">
                                                            <div className="flex items-center gap-2"><Icons.Clock size={20} className="text-orange-400" /><span className="font-bold text-gray-500 text-[10px] md:text-sm uppercase tracking-wide">Th·ªùi gian</span></div>
                                                            <div className="flex items-center gap-2">
                                                                <input type="number" min="2" max="60" value={timeLimitValue} onChange={(e) => setTimeLimitValue(Math.max(2, parseInt(e.target.value) || 2))} disabled={!isTimeLimitEnabled} className="w-10 h-8 text-center font-black rounded-lg border bg-gray-50 outline-none text-sm md:text-base"/>
                                                                <button onClick={() => setIsTimeLimitEnabled(!isTimeLimitEnabled)} className={`relative w-10 h-5 rounded-full transition-colors ${isTimeLimitEnabled ? 'bg-green-500' : 'bg-gray-200'}`}><div className={`absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform ${isTimeLimitEnabled ? 'translate-x-5' : 'translate-x-0'}`} /></button>
                                                            </div>
                                                        </div>

                                                        {/* Circle Buttons Row */}
                                                        <div className="flex items-center justify-between px-2 md:px-6 bg-white py-3 rounded-[2rem] shadow-sm border border-gray-100 w-full">
                                                            <CircleButton 
                                                                icon={isRandomMode ? <Icons.Shuffle size={20}/> : <Icons.SortNumeric size={20}/>} 
                                                                onClick={() => { setIsRandomMode(!isRandomMode); }} 
                                                                active={false}
                                                                color="purple"
                                                                label={isRandomMode ? "Ng·∫´u nhi√™n" : "Tu·∫ßn t·ª±"}
                                                            />
                                                            <div className="w-px h-8 bg-gray-100"></div>
                                                            <CircleButton icon={<Icons.Refresh size={20}/>} onClick={() => {setIsPlaying(false); nextStudyCalculation();}} color="blue" label="ƒê·ªïi s·ªë"/>
                                                            <div className="w-px h-8 bg-gray-100"></div>
                                                            <CircleButton icon={<Icons.Play size={20} fill="currentColor"/>} onClick={() => setIsPlaying(true)} active={isPlaying} color="green" label="T·ª± ch·∫°y" />
                                                            <CircleButton icon={<Icons.Stop size={20} fill="currentColor"/>} onClick={() => setIsPlaying(false)} disabled={!isPlaying} color="red" label="D·ª´ng" />
                                                        </div>

                                                        {/* Check Button Block */}
                                                        <button onClick={() => {setIsPlaying(false); setIsInputMode(true);}} className="bg-blue-600 text-white w-full py-4 rounded-2xl font-black shadow-lg text-base md:text-xl uppercase active:scale-95 transition-all border-b-4 border-blue-800 hover:bg-blue-700 flex items-center justify-center gap-2">
                                                            <Icons.Check size={24} /> Ki·ªÉm tra ngay
                                                        </button>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* B·∫¢NG C√ÄI ƒê·∫∂T N·ªîI TO√ÄN C·ª§C */}
                            <SettingsPanel 
                                isOpen={isSettingsOpen} 
                                onClose={() => setIsSettingsOpen(false)} 
                                scale={scale} setScale={setScale}
                                currentAppSizeId={appSizeId} setAppSizeId={setAppSizeId} 
                                ratioMode={ratioMode} setRatioMode={setRatioMode}
                            />
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
